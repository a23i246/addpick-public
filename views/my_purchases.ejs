<%- include('partials/header', { title: '購入履歴', user }) %>

<h1 class="text-center mb-4"><%= user.name %> さんの購入履歴</h1>

<div class="col-md-10 col-lg-8 mx-auto">

  <!-- 件数とページ情報 -->
  <% if (typeof total !== 'undefined') { %>
    <p class="text-muted small mb-2">
      全 <%= total %> 件 / <%= pageCount %> ページ中 <%= page %> ページ目（1ページ <%= perPage %> 件）
    </p>
  <% } %>

  <% if (purchases.length === 0) { %>
    <div class="alert alert-secondary">まだ購入履歴がありません。</div>
  <% } else { %>
    <ul class="list-group">
      <% purchases.forEach(p => { %>
        <li class="list-group-item">
          <div class="d-flex justify-content-between">
            <strong><%= p.title %></strong>
            <span class="text-muted"><%= new Date(p.created_at).toLocaleString() %></span>
          </div>
          <div class="mt-1">
            <div><strong>商品:</strong> <%= p.product_name %></div>
            <div><strong>価格:</strong> ¥<%= p.unit_price %> / 個</div>
            <div><strong>数量:</strong> <%= p.quantity %> 個</div>
            <div><strong>合計:</strong> ¥<%= p.unit_price * p.quantity %></div>
            <div><strong>企業:</strong> <%= p.company_name %></div>
            <div><strong>紹介者:</strong> <%= p.referrer_name || '—' %></div>
          </div>
        </li>
      <% }) %>
    </ul>

    <!-- ページネーション -->
    <% function linkTo(p){ return '?page=' + p + '&per_page=' + (perPage || 10); } %>
    <nav aria-label="ページネーション" class="mt-3">
      <ul class="pagination justify-content-center">
        <li class="page-item <%= page <= 1 ? 'disabled' : '' %>">
          <a class="page-link" href="<%= page <= 1 ? '#' : linkTo(page - 1) %>">前へ</a>
        </li>

        <% for (let i = 1; i <= pageCount; i++) { %>
          <li class="page-item <%= i === page ? 'active' : '' %>">
            <a class="page-link" href="<%= linkTo(i) %>"><%= i %></a>
          </li>
        <% } %>

        <li class="page-item <%= page >= pageCount ? 'disabled' : '' %>">
          <a class="page-link" href="<%= page >= pageCount ? '#' : linkTo(page + 1) %>">次へ</a>
        </li>
      </ul>
    </nav>
  <% } %>
</div>

<div class="text-center mt-4">
  <a href="/" class="btn btn-secondary">🏠 ホームに戻る</a>
</div>

<%- include('partials/footer') %>
